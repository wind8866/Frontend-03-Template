<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂπøÂ∫¶‰ºòÂÖàÊêúÁ¥¢</title>
    <style>
        .wrap {
            font-size: 0;
            width: 900px;
        }
        .wrap .item {
            display: inline-block;
            width: 8px;
            height: 8px;
            /* border-right: 1px solid #fff;
            border-bottom: 1px solid #fff; */
            margin-right: 1px;
            margin-bottom: 1px;
            background-color: #ddd;
        }
        .wrap .item[data-status="1"] {
            background-color: lightblue;
        }
        .wrap .item[data-status="2"] {
            background-color:#f39f04;
        }
        .wrap .item[data-status="3"] {
            background-color: #888;
        }
        .wrap .item[data-status="4"] {
            background: lightseagreen;
        }
        .wrap .item[data-start] {
            outline: 1px solid lightgreen;
        }
        .wrap .item[data-target] {
            outline: 1px solid red;
        }
    </style>
</head>
<body>
<button id="save">save</button>
<!-- <button id="clean">clean</button> -->
<div id="wrap" class="wrap"></div>
<script src="./defaultmap.js"></script>
<script>
// status: 0Á©∫Ôºõ1Â¢ôÔºõ2ÂêéÁª≠Êìç‰ΩúÔºõ3Âê¶Ôºõ4Ë∑ØÂæÑ
// 
let pressDown = false;
const wrap = document.querySelector('#wrap');
let map = [];
let mapPath = [];
init();
console.log(`search({ x: 5, y: 6}, {x: 56, y: 39})`);

function pause(timer = 5) {
    return new Promise((resolve, reject) => {
        setTimeout(resolve, timer);
    });
}

function setLocalStorage() {
    window.localStorage.setItem('map', JSON.stringify(defaultMap));
}

function review() {
    const nodeList = wrap.childNodes;
    for(let i = 0;i < map.length;i++) {
        nodeList[i].dataset.status = map[i];
        nodeList[i].dataset.remove = map[i];
        nodeList[i].removeAttribute('data-start');
        delete nodeList[i].dataset.target;
    }
}
function setStatus(dot, status) {
    map[dot.x + dot.y * 100] = status;
    wrap.childNodes[dot.x + dot.y * 100].dataset.status = status;
}
function enterList(dot, temp, beforeDot) {
    if (dot.x >= 0 && dot.x < 100 && dot.y >= 0 && dot.y < 100) {
        // Èò≤Ê≠¢ÊñúÂêëÁ©øÂ¢ô(ËÆæÂÆöÂè™ÊúâÂΩìÂâçÁõÆÊ†áÁÇπdot‰∏é‰∏ä‰∏ÄÁõÆÊ†áÁÇπbeforeÂêåÊó∂Áõ∏ÈÇªÁöÑÁÇπÁöÑ‰ΩçÁΩÆÁä∂ÊÄÅ‰∏∫0Êó∂ÊâçÂèØÊñúÂêë)
        const count = Math.abs((dot.x - beforeDot.x) + (dot.y - beforeDot.y));
        if (count === 0 || count === 2) {
            // ÊñúÂêë‰∏∫0„ÄÅ2Êàñ-2ÔºåÁ´ñÂêëÊàñÊ®™Âêë‰∏∫-1Êàñ1
            // Âèñ‰∏édot‰∏ébeforeDotÈÉΩÁõ∏ÈÇªÁöÑ‰∏§‰∏™ÂÄº
            const dot1 = {
                x: dot.x,
                y: beforeDot.y,
            }
            const dot2 = {
                x: beforeDot.x,
                y: dot.y,
            }
            if (map[dot1.x + dot1.y * 100] !== 0 || map[dot2.x + dot2.y * 100] !== 0) {
                // Â¶ÇÊûúÁõ∏ÈÇª‰ΩçÁΩÆÊúâÂÄºÔºåÂ∞±ÁªìÊùüÊñúÂêëÂÜôÂÖ•
                return false;
            }
        }
        if (map[dot.x + dot.y * 100] === 0) {
            map[dot.x + dot.y * 100] = 2;
            // wrap.childNodes[dot.x + dot.y * 100].dataset.status = 2;// ÊòØÂê¶ÊòæÁ§∫ÂΩìÂâçtempÂæÖÈÅçÂéÜÂÖÉÁ¥†
            mapPath[dot.x + dot.y * 100] = beforeDot;
            temp.push(dot);
        }
    }
}
async function showPath(start, end) {
    let path = [];
    let thisDot = end;
    path.unshift(end);
    while(true) {
        if (thisDot.x === start.x && thisDot.y === start.y) {
            break;
        }
        path.unshift(mapPath[thisDot.x + thisDot.y * 100]);
        thisDot = mapPath[thisDot.x + thisDot.y * 100];
    }
    console.log(path);
    for (let dot of path) {
        await pause(50);
        setStatus(dot, 4);
    }
}
async function search(start, end) {
    console.log(start, end)
    mapPath = [...map];
    wrap.childNodes[start.x + start.y * 100].dataset.start = '';
    wrap.childNodes[end.x + end.y * 100].dataset.target = '';
    let temp = [start];
    while (temp.length > 0) {
        await pause();
        const thisDot = temp.shift();
        if (thisDot.x === end.x && thisDot.y === end.y) {
            console.log('ü•≥', thisDot);
            showPath(start, end);
            return;
        }
        setStatus(thisDot, 3);
        wrap.childNodes[thisDot.x + thisDot.y * 100].dataset.status = 3;

        enterList({ x: thisDot.x - 1, y: thisDot.y - 1}, temp, thisDot);// Â∑¶‰∏ä
        enterList({ x: thisDot.x - 0, y: thisDot.y - 1}, temp, thisDot);// ‰∏ä
        enterList({ x: thisDot.x + 1, y: thisDot.y - 1}, temp, thisDot);// Âè≥‰∏ä
        enterList({ x: thisDot.x + 1, y: thisDot.y + 0}, temp, thisDot);// Âè≥
        enterList({ x: thisDot.x + 1, y: thisDot.y + 1}, temp, thisDot);// Âè≥‰∏ã
        enterList({ x: thisDot.x - 0, y: thisDot.y + 1}, temp, thisDot);// ‰∏ã
        enterList({ x: thisDot.x - 1, y: thisDot.y + 1}, temp, thisDot);// Â∑¶‰∏ã
        enterList({ x: thisDot.x - 1, y: thisDot.y + 0}, temp, thisDot);// Â∑¶
        // console.log(temp)
    }
}

function init() {
    const save = document.querySelector('#save');
    wrap.addEventListener('mousedown', () => {pressDown = true});
    wrap.addEventListener('mouseup', () => {pressDown = false});
    wrap.addEventListener('contextmenu', event => {
        event.preventDefault();
        map.fill(0)
        review();
    });
    save.addEventListener('click', () => {
        window.localStorage.setItem('map', JSON.stringify(map));
    });

    if (window.localStorage.getItem('map')) {
        map = JSON.parse(window.localStorage.getItem('map'));
    } else {
        map = Array(10000);
        map.fill(0)
    }

    map.forEach((status, index) => {
        const grid = document.createElement('div');
        grid.addEventListener('mouseover', event => {
            if (pressDown) {
                const target = event.target;
                map[target.dataset.index] = 1;
                target.dataset.status = 1
            }
        })
        grid.classList.add('item');
        grid.dataset.status = status;
        grid.dataset.index = index;
        wrap.append(grid);
    });
}

</script>
</body>
</html>